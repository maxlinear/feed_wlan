From d146e36e6aad79143ba352a822031189d041e460 Mon Sep 17 00:00:00 2001
From: "Ross-Ashikyan, William" <washikyan@maxlinear.com>
Date: Tue, 8 Oct 2024 15:59:46 -0700
Subject: [PATCH] WLANRTSYS-85289 Updated LPI JSON used in composite mode with
 future expiry

Issue: The open source afcd reacts differently to seeing a JSON response with a
past expiry-date. Early internal afcd rejected these messages, but open source
afcd instead begins a 3 minute timer to request a new AFC response from server.
However in composite mode we use a cached LPI UNII 5/7 JSON in order to
configured the bare minumum allowed channels and powers.

Fix: For now, setting a future expiry date for end of 2025 until,
WLANRTSYS-84309 is implemented and we start producing JSONs based on db.txt.

FIXUP to WLANRTSYS-83162 Ported afcd and composite mode changes from legacy hostapd
---
 src/ap/mxl_afc.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/ap/mxl_afc.c b/src/ap/mxl_afc.c
index b3a45e65b..bcd99b462 100644
--- a/src/ap/mxl_afc.c
+++ b/src/ap/mxl_afc.c
@@ -173,7 +173,7 @@ void mxl_hostapd_afc_clear_and_load_lpi(struct hostapd_iface *iface)
 		int ret;
 /* Hardcoded JSON for LPI frequencies and channels in AFC reponse format for US devices operating in composite power mode */
 /* DO NOT breakout and expose to end user, compile into binary, this should NEVER be user-editable */
-		char *composite_lpi_usa_json = "{\"availableSpectrumInquiryResponses\": [{\"response\": {\"responseCode\": 0, \"shortDescription\": \"SUCCESS\"}, \"availableFrequencyInfo\": [{\"frequencyRange\": {\"highFrequency\": 5945, \"lowFrequency\": 5925}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 5965, \"lowFrequency\": 5945}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 5985, \"lowFrequency\": 5965}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6005, \"lowFrequency\": 5985}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6025, \"lowFrequency\": 6005}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6045, \"lowFrequency\": 6025}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6065, \"lowFrequency\": 6045}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6085, \"lowFrequency\": 6065}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6105, \"lowFrequency\": 6085}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6125, \"lowFrequency\": 6105}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6145, \"lowFrequency\": 6125}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6165, \"lowFrequency\": 6145}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6185, \"lowFrequency\": 6165}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6205, \"lowFrequency\": 6185}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6245, \"lowFrequency\": 6225}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6265, \"lowFrequency\": 6245}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6285, \"lowFrequency\": 6265}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6305, \"lowFrequency\": 6285}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6325, \"lowFrequency\": 6305}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6345, \"lowFrequency\": 6325}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6365, \"lowFrequency\": 6345}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6385, \"lowFrequency\": 6365}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6405, \"lowFrequency\": 6385}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6425, \"lowFrequency\": 6405}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6545, \"lowFrequency\": 6525}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6565, \"lowFrequency\": 6545}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6585, \"lowFrequency\": 6565}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6605, \"lowFrequency\": 6585}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6625, \"lowFrequency\": 6605}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6645, \"lowFrequency\": 6625}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6665, \"lowFrequency\": 6645}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6685, \"lowFrequency\": 6665}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6705, \"lowFrequency\": 6685}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6725, \"lowFrequency\": 6705}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6745, \"lowFrequency\": 6725}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6765, \"lowFrequency\": 6745}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6785, \"lowFrequency\": 6765}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6805, \"lowFrequency\": 6785}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6825, \"lowFrequency\": 6805}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6845, \"lowFrequency\": 6825}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6865, \"lowFrequency\": 6845}, \"maxPsd\": 5}], \"availableChannelInfo\": [{\"channelCfi\": [1, 5, 9, 13, 17, 21, 25, 29, 33, 37, 41, 45, 49, 53, 57, 61, 65, 69, 73, 77, 81, 85, 89, 93, 117, 121, 125, 129, 133, 137, 141, 145, 149, 153, 157, 161, 165, 169, 173, 177, 181], \"globalOperatingClass\": 131, \"maxEirp\": [18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0]}, {\"channelCfi\": [3, 11, 19, 27, 35, 43, 51, 59, 67, 75, 83, 91, 123, 131, 139, 147, 155, 163, 171, 179], \"globalOperatingClass\": 132, \"maxEirp\": [21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0]}, {\"channelCfi\": [7, 23, 39, 55, 71, 87, 135, 151, 167], \"globalOperatingClass\": 133, \"maxEirp\": [24.0, 24.0, 24.0, 24.0, 24.0, 24.0, 24.0, 24.0, 24.0]}, {\"channelCfi\": [15, 47, 79, 143], \"globalOperatingClass\": 134, \"maxEirp\": [27.0, 27.0, 27.0, 27.0]}, {\"channelCfi\": [2], \"globalOperatingClass\": 136, \"maxEirp\": [30.0]}], \"requestId\": \"11235813\", \"availabilityExpireTime\": \"2024-07-18T10:26:54Z\", \"rulesetId\": \"US_47_CFR_PART_15_SUBPART_E\"}], \"version\": \"1.4\"}";
+		char *composite_lpi_usa_json = "{\"availableSpectrumInquiryResponses\": [{\"response\": {\"responseCode\": 0, \"shortDescription\": \"SUCCESS\"}, \"availableFrequencyInfo\": [{\"frequencyRange\": {\"highFrequency\": 5945, \"lowFrequency\": 5925}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 5965, \"lowFrequency\": 5945}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 5985, \"lowFrequency\": 5965}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6005, \"lowFrequency\": 5985}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6025, \"lowFrequency\": 6005}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6045, \"lowFrequency\": 6025}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6065, \"lowFrequency\": 6045}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6085, \"lowFrequency\": 6065}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6105, \"lowFrequency\": 6085}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6125, \"lowFrequency\": 6105}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6145, \"lowFrequency\": 6125}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6165, \"lowFrequency\": 6145}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6185, \"lowFrequency\": 6165}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6205, \"lowFrequency\": 6185}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6245, \"lowFrequency\": 6225}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6265, \"lowFrequency\": 6245}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6285, \"lowFrequency\": 6265}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6305, \"lowFrequency\": 6285}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6325, \"lowFrequency\": 6305}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6345, \"lowFrequency\": 6325}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6365, \"lowFrequency\": 6345}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6385, \"lowFrequency\": 6365}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6405, \"lowFrequency\": 6385}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6425, \"lowFrequency\": 6405}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6545, \"lowFrequency\": 6525}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6565, \"lowFrequency\": 6545}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6585, \"lowFrequency\": 6565}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6605, \"lowFrequency\": 6585}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6625, \"lowFrequency\": 6605}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6645, \"lowFrequency\": 6625}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6665, \"lowFrequency\": 6645}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6685, \"lowFrequency\": 6665}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6705, \"lowFrequency\": 6685}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6725, \"lowFrequency\": 6705}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6745, \"lowFrequency\": 6725}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6765, \"lowFrequency\": 6745}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6785, \"lowFrequency\": 6765}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6805, \"lowFrequency\": 6785}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6825, \"lowFrequency\": 6805}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6845, \"lowFrequency\": 6825}, \"maxPsd\": 5}, {\"frequencyRange\": {\"highFrequency\": 6865, \"lowFrequency\": 6845}, \"maxPsd\": 5}], \"availableChannelInfo\": [{\"channelCfi\": [1, 5, 9, 13, 17, 21, 25, 29, 33, 37, 41, 45, 49, 53, 57, 61, 65, 69, 73, 77, 81, 85, 89, 93, 117, 121, 125, 129, 133, 137, 141, 145, 149, 153, 157, 161, 165, 169, 173, 177, 181], \"globalOperatingClass\": 131, \"maxEirp\": [18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0, 18.0]}, {\"channelCfi\": [3, 11, 19, 27, 35, 43, 51, 59, 67, 75, 83, 91, 123, 131, 139, 147, 155, 163, 171, 179], \"globalOperatingClass\": 132, \"maxEirp\": [21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0, 21.0]}, {\"channelCfi\": [7, 23, 39, 55, 71, 87, 135, 151, 167], \"globalOperatingClass\": 133, \"maxEirp\": [24.0, 24.0, 24.0, 24.0, 24.0, 24.0, 24.0, 24.0, 24.0]}, {\"channelCfi\": [15, 47, 79, 143], \"globalOperatingClass\": 134, \"maxEirp\": [27.0, 27.0, 27.0, 27.0]}, {\"channelCfi\": [2], \"globalOperatingClass\": 136, \"maxEirp\": [30.0]}], \"requestId\": \"11235813\", \"availabilityExpireTime\": \"2025-12-31T10:10:10Z\", \"rulesetId\": \"US_47_CFR_PART_15_SUBPART_E\"}], \"version\": \"1.4\"}";
 		mxl_hostapd_afc_delete_data_from_server(iface);
 		ret = mxl_hostapd_afc_parse_reply(iface, composite_lpi_usa_json);
 		if (ret)
-- 
2.43.0

